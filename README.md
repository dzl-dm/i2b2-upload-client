# i2b2 upload client
Utilising a helper file, which uses a custom XML format to define meanings, this application will convert CSV based patient data into fhir-xml format. This is helpful for integrating diverse sources of date into a standardised format for further analysis.

## Helper file
We usually call this the `datasource.xml`. Its a custom xml definition of how the csv patient data is formatted after your custom transformation (which files, which columns map to which parameters, etc).

## Other pre-requisites
This system requires 2 secrets. One to encrypt the user id via a one-way hash (the secret makes it more secure than the hash alone) and one to access the DWH's API for uploading data.
1. `secret_key`: This can be almost anything. Most practically you can use a password - ideally long and complex, generated by and stored in a password manager. You should keep this constant each time you work with a dataset. You can create and use multiple keys for different datasets to increase security and separation of the patient datasets. If the `secret_key` is shared, others with access to it can also upload data for the same patients and record linkage will be possible.
1. `dwh_api_key`: When you are granted access to upload data to the DWH, you will be provided with this. It can be seen as a password and is best stored in a password manager.

## Running the application
The initial aim is to allow the upload process to be run with low effort. This will evolve into a client with few dependencies and high ease of use - after enough development.

### Docker mode
> NOTE: Not updated!

Ensure you have docker installed (eg [docker desktop](https://docs.docker.com/desktop/install/windows-install/)) - [wsl2](https://learn.microsoft.com/en-us/windows/wsl/install) is an advisable pre-requisite to docker-on-windows for performance.
Then start the DWH image as a local container with:
```sh
docker run --name local-dwh-client --rm -it -v my/local/datasources:/datasources -e log_verbosity=1 -e secret_key="ChangeMe" -e dwh_api_key="ChangeMe" ghcr.io/dzl-dm/i2b2-upload-client/i2b2-dwh-client
```
It will run interactively by offering you options for how to proceed.

The `-v my/local/datasources:/datasources` maps the left side on your local filesystem to the right side within docker and will need to contain your datasources in this structure:
ds1/datasource.xml
ds2/datasource.xml
dsN/datasource.xml
> NOTE: Under windows, the left side must be be an absolute path, eg C:\Users\me\datasources

The `datasource.xml` references csv files with data for patients, visits and observations. These references will be respected as previously, it may be necessary to adjust path separators from backslash to forward slash.

The processing only adds or overwrites data in a sub-directory for each datasource called `client-output`, no other data is changed.

### Bash mode (including git for windows/gitbash)
This option has been tested with a linux-like system within windows for the processing. You will need the following installed on your windows system before getting started with the client:
* java 11 - Higher versions won't work as a feature we use was removed. Some older version will work
* python 3.6+ - Tested with python 3.11
* [git for windows](https://git-scm.com/download/win) (gitbash) - There are some options at install time, so behaviour may differ slightly

#### Installation
Download the zip archive and unzip it where you'd like it to reside.
Open a command line terminal with gitbash (You should be able to open `cmd` and use the option next to the new-tab `+` to choose gitbash - method will vary depending on specific versions). Run install script:
```sh
cd path/to/unzipped/client/
./install.sh
```
This checks for dependencies (Java, Python, cURL), installs python libraries and links the functional scripts to the users' PATH.

#### Usage
Now you're ready to use the client.

We use environment variables to connect to the API. There is an optional log level variable. You can set them as below:
```sh
export DWH_API_ENDPOINT=http://localhost
export log_verbosity=2 ## OPTIONAL
```
When you run the client components, it will prompt for the `secret_key` (for pseudonymisation) and the `dwh_api_key` (for authenticating against the DWH API):
```sh
local-processing.sh path/to/datasource.xml [-s f|p]
dwh-processing.sh
```
You must process the data locally with `local-processing.sh`, then as a separate action push it to the DWH with `dwh-processing.sh`. The `-s` (single-mode) option to the local processing script lets you process only to fhir or only pseudonyms (with existing, raw, fhir data). Without the option processes both in 1 go.

### Windows native client
This is planned, but not yet available. This would reduce the installation requirements significantly, usage is expected to be similar.


## How it works
There are 3 stages to the process which are handled by this client. We don't recommend performing these stages directly, if that is necessary, there is possibly a shortcomming in the client, so please let us know and we will aim to fix it.
1. Converting to fhir
1. pseudonymising
1. uploading

This doesn't map exactly to ETL (Extract, Transform, Load) as extraction is a pre-requisite; the csv patient data is already extracted. So these cover most of the transformation part, however further trasnformation is required on the server side before loading (server side) into the i2b2 database.

### Convert to fhir
Once you have clean data in csv files and a matching helper-file (datasource.xml), the following command will produce the data in fhir-xml:
```sh
java -Dfile.encoding="UTF-8" -cp path/to/lib/\* de.sekmi.histream.etl.ExportFHIR datasource.xml > fhir-data-raw.xml
```
At this stage, the data content is unchanged, but re-formatted. Identifiable data will remain until the next stage.

> NOTE: This stage requires `java 11` - more recent versions of java have removed a feature which this code relies on

### Pseudonymise
Here we create a pseudonym for each patient and remove the name information from the data. Comments are also removed from the fhir data as they could hold sensitive information. Each client will generate different pseudonyms for the same patient due to a locally generated secret key. You should aim to keep a backup of the secret key you're using (perhaps in a password manager) to ensure you can always use the same key:
```sh
./process-pid.py
```
The output is still a fhir bundle in XML format, simply with the changes outlined above.

> NOTE: This stage requires `python 3`

### Upload
The DWH presents an API which the client can interface with. A simple way to interact with the API is to use cURL, but most programming languages offer a network library which could be used to communicate.

> NOTE: This stage requires the cURL command to be available, which is included in `git for windows`
